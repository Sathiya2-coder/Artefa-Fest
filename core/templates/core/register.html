{% extends 'base.html' %}
{% load static %}

{% block title %}Register - Enter the Upside Down{% endblock %}

{% block extra_css %}
<style>
.title-container {
            position: relative;
            display: inline-block;
        }
        
        .border-group {
            position: relative;
            margin: 0 -20px;
        }
        
        .top-line, .bottom-line {
            position: relative;
            height: 8px;
            margin: 0 auto;
        }
        
        .top-line::before, .bottom-line::before,
        .top-line::after, .bottom-line::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #e60000;
            box-shadow: 
                0 0 5px #e60000,
                0 0 10px #e60000,
                0 0 15px #e60000;
        }
        
        .top-line::before {
            top: 0;
        }
        
        .top-line::after {
            bottom: 0;
        }
        
        .top-line {
            margin-bottom: 20px;
        }
        
        .bottom-line::before {
            top: 0;
        }
        
        .bottom-line::after {
            bottom: 0;
        }
        
        .bottom-line {
            margin-top: 20px;
        }
        
        .title {
            font-family: 'Benguiat', 'ITC Benguiat', serif;
            font-size: 110px;
            font-weight: 700;
            letter-spacing: 18px;
            color: #000;
            text-align: center;
            line-height: 1;
            position: relative;
        }
        
        .line1, .line2 {
            display: block;
            -webkit-text-stroke: 3px #e60000;
            text-stroke: 3px #e60000;
            paint-order: stroke fill;
            text-shadow: 
                0 0 8px rgba(230, 0, 0, 0.8),
                0 0 15px rgba(230, 0, 0, 0.6),
                0 0 25px rgba(230, 0, 0, 0.4),
                0 0 35px rgba(230, 0, 0, 0.3);
        }
        
        .line1 {
            margin-bottom: -8px;
            letter-spacing: 16px;
        }
        
        .line2 {
            letter-spacing: 22px;
        }
        
        @media (max-width: 1024px) {
            .title {
                font-size: 80px;
                letter-spacing: 14px;
            }
            .line1 {
                letter-spacing: 12px;
            }
            .line2 {
                letter-spacing: 16px;
            }
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 60px;
                letter-spacing: 10px;
            }
            .line1 {
                letter-spacing: 9px;
            }
            .line2 {
                letter-spacing: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .title {
                font-size: 40px;
                letter-spacing: 6px;
            }
            .line1 {
                letter-spacing: 5px;
            }
            .line2 {
                letter-spacing: 8px;
            }
        }
    /* Fixed background container with reveal effect */
    .background-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0; /* Behind everything except body background */
        pointer-events: none; /* Allow clicks to pass through */
        overflow: hidden;
    }

    .background-image {
        --x: -300px; /* Custom CSS property for X position */
        --y: -300px; /* Custom CSS property for Y position */
        
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover; /* Make image fill container while keeping aspect ratio */
        z-index: 1; /* Image visible below mask */
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }

    .background-container:hover .background-image {
        opacity: 0.8;
        z-index: 9999;
    }

    .black-cover {
        --x: -300px; /* Custom CSS property for X position */
        --y: -300px; /* Custom CSS property for Y position */
        
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000000; /* Solid black */
        z-index: 2; /* On top of image with mask hole */
        
        /* Mask - creates a hole in the black cover where image shows */
        -webkit-mask-image:
            radial-gradient(
                circle 200px at var(--x) var(--y),
                transparent 0%,
                transparent 60%,
                black 100%
            );
        mask-image:
            radial-gradient(
                circle 200px at var(--x) var(--y),
                transparent 0%,
                transparent 60%,
                black 100%
            );
        
        pointer-events: none;
    }

    .background-container:hover .black-cover {
        z-index: 9998;
    }

    /* Hide text in circular hover area, show only background */
    .background-container:hover p,
    .background-container:hover h1,
    .background-container:hover h2,
    .background-container:hover h3,
    .background-container:hover h4,
    .background-container:hover h5,
    .background-container:hover h6,
    .background-container:hover input,
    .background-container:hover textarea,
    .background-container:hover label,
    .background-container:hover button,
    .background-container:hover span,
    .background-container:hover .form-group,
    .background-container:hover .registration-card {
        opacity: 0;
        pointer-events: none;
    }

    .noise-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.2'/%3E%3C/svg%3E");
        opacity: 0.6;
        pointer-events: none;
        z-index: 3; /* Texture on top */
        
        /* Mask noise out of circle - visible outside, transparent inside */
        -webkit-mask-image:
            radial-gradient(
                circle 200px at var(--x) var(--y),
                transparent 0%,
                transparent 60%,
                black 100%
            );
        mask-image:
            radial-gradient(
                circle 200px at var(--x) var(--y),
                transparent 0%,
                transparent 60%,
                black 100%
            );
    }

    /* Make content sit above background */
    .registration-hero,
    .registration-section {
        position: relative;
        z-index: 10;
    }

    /* Make content sit above background */
    .registration-hero,
    .registration-section {
        position: relative;
        z-index: 2;
    }

    /* Registration Hero */
    .registration-hero {
        position: relative;
        padding: 150px 0 80px;
        background: linear-gradient(135deg, 
            hsl(var(--stranger-dark) / 0.1), 
            hsl(var(--secondary) / 0.1));
        color: hsl(var(--foreground));
        overflow: hidden;
        text-align: center;
    }

    .registration-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 30%, hsl(var(--primary) / 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 70%, hsl(var(--accent) / 0.1) 0%, transparent 50%),
            repeating-linear-gradient(45deg, 
                transparent, 
                transparent 2px, 
                hsl(var(--primary) / 0.03) 2px, 
                hsl(var(--primary) / 0.03) 4px);
    }

    .registration-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 4rem;
        font-weight: 900;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 4px;
        background: linear-gradient(135deg, 
            hsl(var(--primary)), 
            hsl(var(--stranger-yellow)),
            hsl(var(--primary)));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 0 0 30px hsl(var(--primary) / 0.5);
        position: relative;
        display: inline-block;
    }

    .registration-title::after {
        content: '';
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        width: 150px;
        height: 5px;
        background: linear-gradient(90deg, 
            transparent, 
            hsl(var(--primary)), 
            hsl(var(--stranger-yellow)), 
            hsl(var(--primary)), 
            transparent);
        border-radius: 3px;
    }

    .registration-subtitle {
        font-size: 1.5rem;
        color: hsl(var(--stranger-yellow));
        margin-bottom: 2rem;
        text-shadow: 0 0 10px hsl(var(--stranger-yellow) / 0.5);
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    /* Registration Form */
    .registration-section {
        padding: 50px 0 100px;
        background: hsl(var(--stranger-dark) / 0.75);
        position: relative;
        z-index: 10;
    }
.registration-card {
        background: var(--gradient-card);
        backdrop-filter: blur(20px);
        border: 3px solid hsl(var(--border));
        border-radius: 25px;
        padding: 50px 40px;
        box-shadow: var(--shadow-card);
        position: relative;
        overflow: hidden;
    }

    .registration-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, hsl(var(--primary)), hsl(var(--stranger-orange)));
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 30px;
        position: relative;
    }

    .form-label {
        display: block;
        color: hsl(var(--primary));
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px;
        font-size: 1.1rem;
    }

    .form-label i {
        margin-right: 10px;
        filter: drop-shadow(0 0 5px hsl(var(--primary) / 0.5));
    }

    .form-control, .form-select {
        background: hsl(var(--card)) !important;
        border: 2px solid hsl(var(--border)) !important;
        color: hsl(var(--foreground)) !important;
        padding: 15px 20px;
        border-radius: 12px;
        transition: all 0.3s ease;
        font-size: 1.1rem;
        width: 100%;
        font-weight: 500;
    }

    .form-control:focus, .form-select:focus {
        background: hsl(var(--card)) !important;
        border-color: hsl(var(--primary)) !important;
        color: hsl(var(--foreground)) !important;
        color: hsl(var(--foreground));
        box-shadow: 0 0 0 0.25rem hsl(var(--primary) / 0.25), var(--shadow-red-glow);
        outline: none;
        transform: translateY(-2px);
    }

    .form-control::placeholder, .form-select::placeholder {
        color: hsl(var(--muted-foreground));
        opacity: 0.7;
    }

    .form-text {
        color: hsl(var(--muted-foreground));
        font-size: 0.9rem;
        margin-top: 8px;
        font-style: italic;
    }

    .form-check {
        margin: 0;
    }

    /* Events Selection */
    .events-section {
        margin: 40px 0;
        padding: 40px;
        background: hsl(var(--secondary) / 0.5);
        border-radius: 20px;
        border: 2px solid hsl(var(--border));
    }

    .section-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 2rem;
        font-weight: 700;
        color: hsl(var(--primary));
        margin-bottom: 30px;
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        display: inline-block;
    }

    .section-title::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 0;
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, hsl(var(--primary)), hsl(var(--stranger-yellow)));
    }

    .event-checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .event-checkbox {
        position: relative;
    }

    .event-checkbox input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .event-checkbox label {
        display: block;
        background: var(--gradient-card);
        border: 2px solid hsl(var(--border));
        border-radius: 15px;
        padding: 25px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .event-checkbox label::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, hsl(var(--primary) / 0.1), transparent);
        transition: left 0.6s ease;
    }

    .event-checkbox input:checked + label {
        border-color: hsl(var(--primary));
        background: hsl(var(--primary) / 0.1);
        box-shadow: var(--shadow-card-hover);
        transform: translateY(-5px);
    }

    .event-checkbox input:checked + label::before {
        left: 100%;
    }

    .event-checkbox label:hover {
        border-color: hsl(var(--primary));
        transform: translateY(-3px);
    }

    .event-checkbox label:hover::before {
        left: 100%;
    }

    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .event-name {
        font-size: 1.3rem;
        font-weight: 700;
        color: hsl(var(--foreground));
        margin: 0;
    }

    .event-badge {
        display: inline-block;
        padding: 6px 15px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-technical {
        background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--stranger-red-glow)));
        color: hsl(var(--primary-foreground));
        box-shadow: 0 0 10px hsl(var(--primary) / 0.5);
    }

    .badge-nontech {
        background: linear-gradient(135deg, hsl(var(--stranger-yellow)), hsl(var(--stranger-orange)));
        color: hsl(var(--background));
        box-shadow: 0 0 10px hsl(var(--stranger-yellow) / 0.5);
    }

    .event-details {
        color: hsl(var(--muted-foreground));
        line-height: 1.6;
        margin-bottom: 15px;
        font-size: 0.95rem;
    }

    .event-meta {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
        color: hsl(var(--muted-foreground));
        font-size: 0.9rem;
    }

    .meta-item i {
        color: hsl(var(--primary));
    }

    /* Team Fields */
    .team-fields {
        background: hsl(var(--secondary) / 0.5);
        border: 2px solid hsl(var(--border));
        border-radius: 20px;
        padding: 40px;
        margin: 40px 0;
        border-left: 5px solid hsl(var(--primary));
        display: none;
        animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .team-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: hsl(var(--primary));
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .team-title i {
        filter: drop-shadow(0 0 5px hsl(var(--primary) / 0.5));
    }

    /* Submit Button */
    .submit-section {
        text-align: center;
        margin-top: 50px;
    }

    .submit-button {
        background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--stranger-orange))) !important;
        color: hsl(var(--primary-foreground)) !important;
        border: none !important;
        padding: 18px 55px;
        border-radius: 50px;
        font-size: 1.2rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        z-index: 1;
        box-shadow: var(--shadow-red-glow);
        cursor: pointer;
    }

    .submit-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, hsl(0 100% 100% / 0.2), transparent);
        transition: left 0.6s ease;
        z-index: -1;
    }

    .submit-button:hover {
        transform: translateY(-5px) scale(1.05) !important;
        box-shadow: var(--shadow-red-intense) !important;
        background: linear-gradient(135deg, hsl(var(--primary) / 0.9), hsl(var(--stranger-orange) / 0.9)) !important;
    }

    .submit-button:hover::before {
        left: 100%;
    }

    .submit-button i {
        margin-right: 15px;
        font-size: 1.5rem;
    }

    /* Check Registration Button */
    .check-registration {
        text-align: center;
        margin-top: 30px;
    }

    .check-button {
        background: transparent !important;
        border: 2px solid hsl(var(--primary)) !important;
        color: hsl(var(--primary)) !important;
        padding: 12px 40px;
        border-radius: 50px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        z-index: 1;
        cursor: pointer;
    }

    .check-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: hsl(var(--primary) / 0.1);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s ease, height 0.6s ease;
        z-index: -1;
    }

    .check-button:hover::before {
        width: 300%;
        height: 300%;
    }

    .check-button:hover {
        color: hsl(var(--primary-foreground)) !important;
        border-color: hsl(var(--primary)) !important;
        box-shadow: var(--shadow-red-glow) !important;
        background: hsl(var(--primary) / 0.1) !important;
    }

    /* Team Creation Button */
    .team-creation-section {
        text-align: center;
        margin-top: 30px;
    }

    .team-button {
        background: linear-gradient(135deg, #e02401, #ff6b35) !important;
        border: 2px solid #e02401 !important;
        color: hsl(var(--primary-foreground)) !important;
        padding: 12px 40px;
        border-radius: 50px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        z-index: 1;
        cursor: pointer;
    }

    .team-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s ease, height 0.6s ease;
        z-index: -1;
    }

    .team-button:hover::before {
        width: 300%;
        height: 300%;
    }

    .team-button:hover {
        color: hsl(var(--primary-foreground)) !important;
        border-color: #ff6b35 !important;
        box-shadow: 0 0 30px rgba(224, 36, 1, 0.6) !important;
        transform: translateY(-2px);
        text-shadow: 0 0 10px rgba(224, 36, 1, 0.5);
    }

    .team-button i {
        margin-right: 8px;
        font-size: 1.3rem;
    }

    /* Error Messages */
    .error-message {
        color: hsl(var(--primary));
        font-size: 0.9rem;
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .error-message i {
        color: hsl(var(--stranger-red-glow));
    }

    /* âœ… Invalid Form Control Styling */
    .form-control.is-invalid,
    .form-select.is-invalid {
        border-color: hsl(0 92% 48%) !important;
        background-color: hsl(0 92% 48% / 0.05);
        box-shadow: 0 0 0 0.2rem hsl(0 92% 48% / 0.25);
    }

    /* Success Message */
    .success-message {
        background: linear-gradient(135deg, hsl(142 76% 36% / 0.2), transparent);
        border: 2px solid hsl(142 76% 36%);
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        margin: 30px 0;
        color: hsl(142 76% 70%);
    }

    /* Modal Styling */
    .modal-content {
        background: var(--gradient-card);
        border: 2px solid hsl(var(--border));
        border-radius: 20px;
        color: hsl(var(--foreground));
    }

    .modal-header {
        background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--stranger-orange)));
        color: hsl(var(--primary-foreground));
        border-bottom: 2px solid hsl(var(--primary));
        border-radius: 18px 18px 0 0;
        padding: 25px 30px;
    }

    .modal-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    .modal-body {
        padding: 30px;
    }

    .modal-footer {
        background: hsl(var(--secondary) / 0.5);
        border-top: 1px solid hsl(var(--border));
        border-radius: 0 0 18px 18px;
        padding: 20px 30px;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .registration-title {
            font-size: 3rem;
        }
        
        .registration-card {
            padding: 40px 30px;
        }
        
        .event-checkbox-group {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .registration-hero {
            padding: 120px 0 60px;
        }
        
        .registration-title {
            font-size: 2.5rem;
        }
        
        .registration-subtitle {
            font-size: 1.2rem;
        }
        
        .events-section, .team-fields {
            padding: 30px 20px;
        }
        
        .event-checkbox-group {
            grid-template-columns: 1fr;
        }
        
        .submit-button {
            padding: 15px 40px;
            font-size: 1.1rem;
        }
    }

    @media (max-width: 576px) {
        .registration-title {
            font-size: 2rem;
            letter-spacing: 2px;
        }
        
        .section-title {
            font-size: 1.5rem;
        }
        
        .form-control, .form-select {
            padding: 12px 15px;
            font-size: 1rem;
        }
        
        .event-name {
            font-size: 1.1rem;
        }
        
        .submit-button {
            padding: 12px 30px;
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Background Reveal Effect -->
<div class="background-container">
    <img src="{% static 'images/titlecasrd.jpeg' %}" class="background-image" id="backgroundImage" alt="Background">
    <div class="black-cover" id="blackCover"></div>
    <div class="noise-layer" id="noiseLayer"></div>
</div>

<!-- Lightning Canvas -->
<canvas id="lightningCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none;"></canvas>

<!-- Registration Hero -->
<section class="registration-hero">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <div class="title-container">
                    <div class="border-group">
                        <div class="top-line"></div>
                    </div>
                    <div class="title">
                        <span class="line1">REGISTER</span>
                        <span class="line2">FEST</span>
                    </div>
                    <div class="border-group">
                        <div class="bottom-line"></div>
                    </div>
                </div>
                <br><br>
                <h1 class="registration-title">ENTER THE PORTAL</h1>
                <p class="registration-subtitle">
                    Step into the Upside Down and join the adventure. Fill in your interdimensional coordinates to begin your journey.
                </p>
                <p class="lead" style="color: hsl(var(--muted-foreground)); font-size: 1.1rem;">
                    <i class="fas fa-exclamation-triangle me-2"></i>Registration closes: February 1, 2026
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Registration Form -->
<section class="registration-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="registration-card">
                    {% if messages %}
                    <div style="margin-bottom: 30px;">
                        {% for message in messages %}
                            {% if message.tags == 'success' %}
                            <div class="alert alert-success alert-dismissible fade show" role="alert" style="background: hsl(142 76% 36% / 0.1); border: 2px solid hsl(142 76% 36%); color: hsl(142 76% 70%);">
                                <i class="fas fa-check-circle"></i>
                                <strong>Success!</strong> {{ message }}
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            {% else %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert" style="background: hsl(0 92% 48% / 0.1); border: 2px solid hsl(0 92% 48%); color: hsl(0 92% 70%);">
                                <i class="fas fa-exclamation-circle"></i>
                                <strong>Error:</strong> {{ message }}
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <form method="post" id="registrationForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Personal Information -->
                        <div class="section-title">
                            <i class="fas fa-user-astronaut"></i>Interdimensional Explorer
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.full_name.id_for_label }}" class="form-label">
                                        <i class="fas fa-user"></i>Full Name
                                    </label>
                                    {{ form.full_name }}
                                    {% if form.full_name.errors %}
                                    <div class="error-message">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ form.full_name.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.register_number.id_for_label }}" class="form-label">
                                        <i class="fas fa-id-card"></i>Register Number
                                    </label>
                                    {{ form.register_number }}
                                    <div class="form-text">Example: 21AID001, 22AID045</div>
                                    {% if form.register_number.errors %}
                                    <div class="error-message">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ form.register_number.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.year.id_for_label }}" class="form-label">
                                        <i class="fas fa-calendar"></i>Year
                                    </label>
                                    {{ form.year }}
                                    {% if form.year.errors %}
                                    <div class="error-message">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ form.year.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.department.id_for_label }}" class="form-label">
                                        <i class="fas fa-building"></i>Department
                                    </label>
                                    {{ form.department }}
                                    {% if form.department.errors %}
                                    <div class="error-message">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ form.department.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                                        <i class="fas fa-phone"></i>Phone Number
                                    </label>
                                    {{ form.phone_number }}
                                    {% if form.phone_number.errors %}
                                    <div class="error-message">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ form.phone_number.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                <i class="fas fa-envelope"></i>Email Address
                            </label>
                            {{ form.email }}
                            <div class="form-text">Confirmation will be sent to this email</div>
                            {% if form.email.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.email.errors }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Events Selection -->
                        <div class="events-section">
                            <div class="section-title">
                                <i class="fas fa-trophy"></i>Select Your Competition
                            </div>
                            <p style="color: hsl(var(--muted-foreground)); margin-bottom: 25px;">
                                Choose the competition you want to participate in. Select wisely, as each participant can only register for one competition!
                            </p>
                            
                            <div class="form-group">
                                <label for="{{ form.events.id_for_label }}" class="form-label" style="font-weight: 600; color: hsl(var(--foreground)); margin-bottom: 12px;">
                                    <i class="fas fa-portal"></i> Competition Name
                                </label>
                                {{ form.events }}
                                {% if form.events.errors %}
                                <div class="error-message" style="margin-top: 10px;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {{ form.events.errors }}
                                </div>
                                {% endif %}
                                
                                <!-- Competition Details Display -->
                                <div id="competitionDetails" style="margin-top: 20px; display: none; background: rgba(224, 36, 1, 0.1); border-left: 4px solid #e02401; padding: 15px; border-radius: 8px;">
                                    <div style="color: #e02401; font-weight: 600; margin-bottom: 10px;">
                                        <i class="fas fa-info-circle"></i> Competition Details
                                    </div>
                                    <div id="compDetails" style="color: hsl(var(--muted-foreground));">
                                        Select a competition to see details
                                    </div>
                                </div>
                            </div>
                            
                            {% if form.events.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.events.errors }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Team Information Section -->
                        <div style="margin-top: 40px; padding-bottom: 20px; border-bottom: 2px solid hsl(var(--primary) / 0.2);">
                            <div class="section-title" style="margin-bottom: 30px;">
                                <i class="fas fa-users"></i>Form Your Squad (Optional)
                            </div>
                        </div>
                        
                        <!-- Team Information -->
                        <div id="teamFields" class="team-fields" style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, hsl(var(--card)) 0%, hsl(var(--primary) / 0.05) 100%); border: 2px solid hsl(var(--primary) / 0.3); border-radius: 12px;">
                            <p style="color: hsl(var(--muted-foreground)); margin-bottom: 25px; font-size: 0.95rem;">
                                <i class="fas fa-info-circle" style="margin-right: 8px; color: hsl(var(--primary));"></i>Leave team fields empty to register as a solo participant. Fill team information to create or join a team.
                            </p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.team_name.id_for_label }}" class="form-label" style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <i class="fas fa-flag" style="margin-right: 8px; color: #e02401;"></i>
                                            <span>Team Name <span id="teamNameRequired" style="color: #e02401; font-weight: bold; display: none;">*</span></span>
                                        </label>
                                        {{ form.team_name }}
                                        <div class="form-text" style="margin-top: 6px;">
                                            <i class="fas fa-lightbulb"></i> e.g., Phoenix Squad (optional for solo registration)
                                        </div>
                                        {% if form.team_name.errors %}
                                        <div class="error-message" style="margin-top: 8px;">
                                            <i class="fas fa-exclamation-circle"></i>
                                            {{ form.team_name.errors }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.team_member_count.id_for_label }}" class="form-label" style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <i class="fas fa-users" style="margin-right: 8px; color: #e02401;"></i>
                                            <span>Team Member Count <span id="teamCountRequired" style="color: #e02401; font-weight: bold; display: none;">*</span></span>
                                        </label>
                                        {{ form.team_member_count }}
                                        <div class="form-text" style="margin-top: 6px;">
                                            <i class="fas fa-info-circle"></i> <span id="memberCountHelp">Select a team event first</span>
                                            <span id="teamSizeLimits" style="display: none; margin-left: 8px; color: hsl(var(--primary)); font-weight: 500;">
                                                Max: <span id="maxTeamSize">0</span> members
                                            </span>
                                        </div>
                                        {% if form.team_member_count.errors %}
                                        <div class="error-message" style="margin-top: 8px;">
                                            <i class="fas fa-exclamation-circle"></i>
                                            {{ form.team_member_count.errors }}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Dynamic Team Members Section - Below Count Field -->
                                        <div id="teamMembersContainer" style="margin-top: 20px; display: none; padding: 15px; background: hsl(142 76% 36% / 0.1); border-radius: 6px; border: 1px solid hsl(142 76% 36% / 0.3);">
                                            <h6 style="color: hsl(var(--foreground)); margin-bottom: 15px; display: flex; align-items: center;">
                                                <i class="fas fa-list" style="margin-right: 8px;"></i> Enter Team Members Details
                                            </h6>
                                            <div id="membersInputs" style="display: flex; flex-direction: column; gap: 12px;">
                                                <!-- Dynamic inputs will be generated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Password Section -->
                        <div style="margin-top: 40px; padding-bottom: 20px; border-bottom: 2px solid hsl(var(--primary) / 0.2);">
                            <div class="section-title" style="margin-bottom: 30px;">
                                <i class="fas fa-lock"></i>Secure Your Account
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, hsl(var(--card)) 0%, hsl(var(--primary) / 0.05) 100%); border: 2px solid hsl(var(--primary) / 0.3); border-radius: 12px;">
                            <p style="color: hsl(var(--muted-foreground)); margin-bottom: 25px; font-size: 0.95rem;">
                                <i class="fas fa-info-circle" style="margin-right: 8px; color: hsl(var(--primary));"></i><span id="passwordHelp">Password is optional for solo registration, but required if you're creating a team.</span>
                            </p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.password.id_for_label }}" class="form-label" style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <i class="fas fa-key" style="margin-right: 8px; color: #e02401;"></i>
                                            <span>Password <span id="passwordRequired" style="color: #e02401; font-weight: bold; display: none;">*</span></span>
                                        </label>
                                        {{ form.password }}
                                        <div class="form-text" style="margin-top: 6px;">
                                            <i class="fas fa-shield-alt"></i> <span id="passwordHelp2">Create a strong password (min 8 characters) - optional for solo registration</span>
                                        </div>
                                        {% if form.password.errors %}
                                        <div class="error-message" style="margin-top: 8px;">
                                            <i class="fas fa-exclamation-circle"></i>
                                            {{ form.password.errors }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.confirm_password.id_for_label }}" class="form-label" style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <i class="fas fa-check-circle" style="margin-right: 8px; color: #e02401;"></i>
                                            <span>Confirm Password <span id="confirmRequired" style="color: #e02401; font-weight: bold; display: none;">*</span></span>
                                        </label>
                                        {{ form.confirm_password }}
                                        <div class="form-text" style="margin-top: 6px;">
                                            <i class="fas fa-copy"></i> Re-enter your password
                                        </div>
                                        {% if form.confirm_password.errors %}
                                        <div class="error-message" style="margin-top: 8px;">
                                            <i class="fas fa-exclamation-circle"></i>
                                            {{ form.confirm_password.errors }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden field for team members data -->
                        {{ form.team_members }}
                        
                        <!-- Team Creation Section -->
                        <div class="team-submission-section" style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, hsl(142 76% 36% / 0.1) 0%, hsl(142 76% 36% / 0.05) 100%); border: 2px solid hsl(142 76% 36%); border-radius: 12px;">
                            <div style="margin-bottom: 20px;">
                                <h6 style="margin-bottom: 15px; color: hsl(var(--foreground));">
                                    <i class="fas fa-rocket" style="margin-right: 8px; color: hsl(142 76% 36%);"></i>
                                    Complete Your Registration
                                </h6>
                                <p style="color: hsl(var(--muted-foreground)); font-size: 0.9rem; margin: 0;">
                                    <i class="fas fa-check-circle"></i> All your information will be saved
                                </p>
                                <p style="color: hsl(var(--muted-foreground)); font-size: 0.9rem; margin: 5px 0;">
                                    <i class="fas fa-users"></i> Team will be created with your members
                                </p>
                                <p style="color: hsl(var(--muted-foreground)); font-size: 0.9rem; margin: 5px 0;">
                                    <i class="fas fa-lock"></i> Team password will be generated automatically
                                </p>
                            </div>
                            
                            <button type="submit" class="btn btn-success btn-lg w-100" id="submitRegistration" style="font-size: 1.1rem; font-weight: 600; padding: 15px; margin-top: 15px;">
                                <i class="fas fa-check-double me-2"></i>Register & Create Team
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
    // Lightning Effects
    const canvas = document.getElementById("lightningCanvas");
    const ctx = canvas.getContext("2d");

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener("resize", resize);

    const config = {
        color: "#ff2a2a",
        shadow: "#ff0000",
        thickness: 3,
        maxBranches: 3,
        branchChance: 0.6
    };

    function drawLightning(x1, y1, x2, y2, displace, depth = 0) {
        if (displace < 5 || depth > config.maxBranches) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            return;
        }
        const midX = (x1 + x2) / 2 + (Math.random() - 0.5) * displace;
        const midY = (y1 + y2) / 2 + (Math.random() - 0.5) * displace;
        drawLightning(x1, y1, midX, midY, displace / 2, depth);
        drawLightning(midX, midY, x2, y2, displace / 2, depth);
        if (Math.random() < config.branchChance) {
            drawLightning(midX, midY, midX + (Math.random() - 0.5) * displace * 2, midY + Math.random() * displace * 2, displace / 2, depth + 1);
        }
    }

    function createLightningHoles(startX, startY, endX, endY) {
        const blackCover = document.getElementById("blackCover");
        const noiseLayer = document.getElementById("noiseLayer");
        if (!blackCover || !noiseLayer) return;
        const maskGradients = [];
        for (let i = 0; i <= 10; i++) {
            const t = i / 10;
            const x = startX + (endX - startX) * t + (Math.random() - 0.5) * 50;
            const y = startY + (endY - startY) * t + (Math.random() - 0.5) * 50;
            maskGradients.push(`radial-gradient(circle 80px at ${x}px ${y}px, transparent 0%, transparent 40%, black 100%)`);
        }
        if (maskGradients.length > 0) {
            const maskValue = maskGradients.join(', ');
            blackCover.style.webkitMaskImage = maskValue;
            blackCover.style.maskImage = maskValue;
            noiseLayer.style.webkitMaskImage = maskValue;
            noiseLayer.style.maskImage = maskValue;
            blackCover.style.opacity = '0.5';
            noiseLayer.style.opacity = '0.3';
        }
    }

    function resetBlackCover() {
        const blackCover = document.getElementById("blackCover");
        const noiseLayer = document.getElementById("noiseLayer");
        if (blackCover && noiseLayer) {
            blackCover.style.webkitMaskImage = 'none';
            blackCover.style.maskImage = 'none';
            blackCover.style.opacity = '1';
            noiseLayer.style.webkitMaskImage = 'none';
            noiseLayer.style.maskImage = 'none';
            noiseLayer.style.opacity = '0.6';
        }
    }

    function lightningStrike() {
        const startX = Math.random() * canvas.width;
        const endX = startX + (Math.random() - 0.5) * 200;
        const endY = canvas.height * (0.4 + Math.random() * 0.6);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "rgba(255, 50, 50, 0.15)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = config.color;
        ctx.shadowColor = config.shadow;
        ctx.shadowBlur = 80;
        ctx.lineWidth = config.thickness;
        ctx.lineCap = "round";
        createLightningHoles(startX, 0, endX, endY);
        drawLightning(startX, 0, endX, endY, 90);
        let alpha = 1;
        const fade = setInterval(() => {
            alpha -= 0.13;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = alpha;
            ctx.fillStyle = `rgba(255, 50, 50, ${alpha * 0.15})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = alpha;
            ctx.strokeStyle = config.color;
            ctx.shadowColor = config.shadow;
            ctx.shadowBlur = 80;
            ctx.lineWidth = config.thickness;
            ctx.lineCap = "round";
            drawLightning(startX, 0, endX, endY, 90 * alpha);
            const blackCover = document.getElementById("blackCover");
            const noiseLayer = document.getElementById("noiseLayer");
            if (blackCover && noiseLayer) {
                blackCover.style.opacity = (0.5 * alpha).toString();
                noiseLayer.style.opacity = (0.3 * alpha).toString();
            }
            if (alpha <= 0) {
                clearInterval(fade);
                ctx.globalAlpha = 1;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                resetBlackCover();
            }
        }, 30);
    }

    setInterval(() => { lightningStrike(); }, 2000);
    setTimeout(() => { lightningStrike(); }, 500);

    document.addEventListener("mousemove", function(e) {
        const blackCover = document.getElementById("blackCover");
        const noiseLayer = document.getElementById("noiseLayer");
        const x = e.clientX;
        const y = e.clientY;
        if (blackCover && noiseLayer) {
            const maskValue = `radial-gradient(circle 200px at ${x}px ${y}px, transparent 0%, transparent 60%, black 100%)`;
            blackCover.style.webkitMaskImage = maskValue;
            blackCover.style.maskImage = maskValue;
            noiseLayer.style.webkitMaskImage = maskValue;
            noiseLayer.style.maskImage = maskValue;
            blackCover.style.opacity = '1';
            noiseLayer.style.opacity = '0.6';
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Background reveal effect
        const backgroundImage = document.getElementById("backgroundImage");
        const blackCover = document.getElementById("blackCover");
        const noiseLayer = document.getElementById("noiseLayer");
        
        // Initialize background effect
        if (backgroundImage && blackCover && noiseLayer) {
            backgroundImage.style.setProperty("--x", "-300px");
            backgroundImage.style.setProperty("--y", "-300px");
            blackCover.style.setProperty("--x", "-300px");
            blackCover.style.setProperty("--y", "-300px");
            noiseLayer.style.setProperty("--x", "-300px");
            noiseLayer.style.setProperty("--y", "-300px");
        }
        
        // Track mouse movement for background reveal
        document.addEventListener("mousemove", e => {
            const x = e.clientX;
            const y = e.clientY;
            
            if (backgroundImage) {
                backgroundImage.style.setProperty("--x", x + "px");
                backgroundImage.style.setProperty("--y", y + "px");
            }
            
            if (blackCover) {
                blackCover.style.setProperty("--x", x + "px");
                blackCover.style.setProperty("--y", y + "px");
            }
            
            if (noiseLayer) {
                noiseLayer.style.setProperty("--x", x + "px");
                noiseLayer.style.setProperty("--y", y + "px");
            }
        });
        
        // Reset on mouse leave
        document.addEventListener("mouseleave", () => {
            if (backgroundImage) {
                backgroundImage.style.setProperty("--x", "-300px");
                backgroundImage.style.setProperty("--y", "-300px");
            }
            
            if (blackCover) {
                blackCover.style.setProperty("--x", "-300px");
                blackCover.style.setProperty("--y", "-300px");
            }
            
            if (noiseLayer) {
                noiseLayer.style.setProperty("--x", "-300px");
                noiseLayer.style.setProperty("--y", "-300px");
            }
        });
        
        // Handle competition dropdown selection
        const competitionSelect = document.getElementById('id_events');
        const teamFields = document.getElementById('teamFields');
        const competitionDetails = document.getElementById('competitionDetails');
        const compDetailsDiv = document.getElementById('compDetails');
        
        // If element not found by id_events, try competitionSelect for backwards compatibility
        if (!competitionSelect && document.getElementById('competitionSelect')) {
            competitionSelect = document.getElementById('competitionSelect');
        }
        
        // Data structure for competitions (populated from Django context or via data attributes)
        const competitionData = {};
        
        // Populate competition data from selected options
        if (competitionSelect) {
            Array.from(competitionSelect.options).forEach(option => {
                if (option.value) {
                    // Parse any data attributes or fallback to default structure
                    competitionData[option.value] = {
                        name: option.textContent.trim(),
                        isTeamEvent: option.dataset.team === 'true',
                        minTeamSize: parseInt(option.dataset.minTeamSize) || 1,
                        maxTeamSize: parseInt(option.dataset.teamSize) || 4,
                        description: option.dataset.description || 'No description available'
                    };
                }
            });
        }
        
        // Count team members entered
        function countTeamMembers() {
            const teamMembersInput = document.getElementById('id_team_members');
            if (!teamMembersInput) return 0;
            
            const value = teamMembersInput.value.trim();
            if (!value) return 0;
            
            const members = value.split(',').map(m => m.trim()).filter(m => m.length > 0);
            return members.length;
        }
        
        // Update team count display
        function updateTeamCountDisplay() {
            const selectedValue = competitionSelect.value;
            const teamCountDisplay = document.getElementById('teamCountDisplay');
            const requiredTeamCount = document.getElementById('requiredTeamCount');
            const teamCountText = document.getElementById('teamCountText');
            
            if (!selectedValue) {
                if (teamCountDisplay) teamCountDisplay.innerHTML = '<i class="fas fa-info-circle"></i> <span id="teamCountText">Select an event to see team requirements</span>';
                if (requiredTeamCount) requiredTeamCount.textContent = 'team member';
                return;
            }
            
            const selected = competitionData[selectedValue];
            if (selected) {
                const currentCount = countTeamMembers();
                const maxSize = selected.maxTeamSize;
                const minSize = selected.minTeamSize;
                
                if (requiredTeamCount) {
                    requiredTeamCount.textContent = `${minSize}-${maxSize} team member${maxSize > 1 ? 's' : ''}`;
                }
                
                if (teamCountDisplay) {
                    if (currentCount === 0) {
                        teamCountDisplay.innerHTML = `<i class="fas fa-info-circle" style="color: hsl(var(--muted-foreground));"></i> <span>Need ${minSize}-${maxSize} team members for ${selected.name}</span>`;
                    } else if (currentCount >= minSize && currentCount <= maxSize) {
                        teamCountDisplay.innerHTML = `<i class="fas fa-check-circle" style="color: hsl(142 76% 36%);"></i> <span style="color: hsl(142 76% 36%);">âœ“ Perfect! ${currentCount} member${currentCount > 1 ? 's' : ''} entered</span>`;
                    } else if (currentCount < minSize) {
                        teamCountDisplay.innerHTML = `<i class="fas fa-exclamation-circle" style="color: hsl(38 92% 50%);"></i> <span style="color: hsl(38 92% 50%);">âš  Need ${minSize - currentCount} more member${minSize - currentCount > 1 ? 's' : ''}</span>`;
                    } else {
                        teamCountDisplay.innerHTML = `<i class="fas fa-times-circle" style="color: hsl(0 92% 48%);"></i> <span style="color: hsl(0 92% 48%);">âœ— Too many members! Maximum is ${maxSize}</span>`;
                    }
                }
            }
        }
        
        function handleCompetitionChange() {
            const selectedValue = competitionSelect.value;
            
            if (!selectedValue) {
                competitionDetails.style.display = 'none';
                return;
            }
            
            const selected = competitionData[selectedValue];
            
            if (selected) {
                // Show competition details
                competitionDetails.style.display = 'block';
                compDetailsDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <i class="fas fa-trophy" style="color: #e02401; margin-top: 5px; flex-shrink: 0;"></i>
                        <div style="flex-grow: 1;">
                            <p style="margin-bottom: 8px;"><strong>Event Type:</strong> ${selected.isTeamEvent ? 'Team Event' : 'Individual Event'}</p>
                            ${selected.isTeamEvent ? `<p style="margin-bottom: 0;"><strong>Team Size:</strong> ${selected.minTeamSize}-${selected.maxTeamSize} members</p>` : ''}
                            <p style="margin-bottom: 0;"><strong>Description:</strong> ${selected.description}</p>
                        </div>
                    </div>
                `;
                
                // Always show team fields
                teamFields.style.display = 'block';
                
                // âœ… UPDATE TEAM SIZE LIMITS IN HELP TEXT
                const teamSizeLimits = document.getElementById('teamSizeLimits');
                const maxTeamSizeSpan = document.getElementById('maxTeamSize');
                const memberCountHelp = document.getElementById('memberCountHelp');
                
                if (selected.isTeamEvent) {
                    memberCountHelp.textContent = `Team members: min ${selected.minTeamSize}, max ${selected.maxTeamSize}`;
                    if (maxTeamSizeSpan) maxTeamSizeSpan.textContent = selected.maxTeamSize;
                    if (teamSizeLimits) teamSizeLimits.style.display = 'inline';
                    
                    // âœ… SET MAX ATTRIBUTE ON INPUT FIELD
                    if (teamMemberCountInput) {
                        teamMemberCountInput.setAttribute('max', selected.maxTeamSize);
                        teamMemberCountInput.setAttribute('min', selected.minTeamSize);
                    }
                } else {
                    memberCountHelp.textContent = 'Select a team event first';
                    if (teamSizeLimits) teamSizeLimits.style.display = 'none';
                }
                
                // Update team count display
                updateTeamCountDisplay();
                
                // Update required field indicators based on team event
                updateRequiredFields();
            }
        }
        
        // Function to update required field indicators
        function updateRequiredFields() {
            const teamNameInput = document.getElementById('id_team_name');
            const teamNameValue = teamNameInput ? teamNameInput.value.trim() : '';
            
            const teamNameRequired = document.getElementById('teamNameRequired');
            const teamCountRequired = document.getElementById('teamCountRequired');
            const passwordRequired = document.getElementById('passwordRequired');
            const confirmRequired = document.getElementById('confirmRequired');
            const passwordHelp = document.getElementById('passwordHelp');
            const passwordHelp2 = document.getElementById('passwordHelp2');
            
            if (teamNameValue) {
                // Team name provided - show all required indicators
                if (teamNameRequired) teamNameRequired.style.display = 'inline';
                if (teamCountRequired) teamCountRequired.style.display = 'inline';
                if (passwordRequired) passwordRequired.style.display = 'inline';
                if (confirmRequired) confirmRequired.style.display = 'inline';
                if (passwordHelp) passwordHelp.textContent = 'Password is required to secure your team.';
                if (passwordHelp2) passwordHelp2.textContent = 'Create a strong password (min 8 characters) - required for team creation';
            } else {
                // No team name - team fields optional
                if (teamNameRequired) teamNameRequired.style.display = 'none';
                if (teamCountRequired) teamCountRequired.style.display = 'none';
                if (passwordRequired) passwordRequired.style.display = 'none';
                if (confirmRequired) confirmRequired.style.display = 'none';
                if (passwordHelp) passwordHelp.textContent = 'Password is optional for solo registration, but required if you\'re creating a team.';
                if (passwordHelp2) passwordHelp2.textContent = 'Create a strong password (min 8 characters) - optional for solo registration';
            }
        }
        
        // Listen to team name input changes
        const teamNameInput = document.getElementById('id_team_name');
        if (teamNameInput) {
            teamNameInput.addEventListener('input', updateRequiredFields);
            teamNameInput.addEventListener('change', updateRequiredFields);
        }
        
        if (competitionSelect) {
            competitionSelect.addEventListener('change', handleCompetitionChange);
            // Trigger on page load in case a value is pre-selected
            handleCompetitionChange();
        }
        
        // Listen for team members input changes to update count display
        const teamMembersInput = document.getElementById('id_team_members');
        if (teamMembersInput) {
            teamMembersInput.addEventListener('input', updateTeamCountDisplay);
            teamMembersInput.addEventListener('change', updateTeamCountDisplay);
        }
        
        // Handle team member count input - generate dynamic fields
        const teamMemberCountInput = document.getElementById('id_team_member_count');
        const teamMembersContainer = document.getElementById('teamMembersContainer');
        const membersInputs = document.getElementById('membersInputs');
        
        console.log('Elements found:', {
            teamMemberCountInput: !!teamMemberCountInput,
            teamMembersContainer: !!teamMembersContainer,
            membersInputs: !!membersInputs
        });
        
        function generateMemberInputs() {
            console.log('generateMemberInputs called');
            
            if (!teamMemberCountInput || !teamMembersContainer || !membersInputs) {
                console.error('Missing required elements');
                return;
            }
            
            const count = parseInt(teamMemberCountInput.value) || 0;
            const selectedEvent = competitionSelect.value;
            
            console.log('Count:', count, 'Event:', selectedEvent);
            
            if (!selectedEvent || count <= 0) {
                teamMembersContainer.style.display = 'none';
                teamMembersInput.value = '';
                return;
            }
            
            const selected = competitionData[selectedEvent];
            if (!selected) {
                console.warn('Event not found in competitionData');
                teamMembersContainer.style.display = 'none';
                return;
            }
            
            // Validate count against min/max
            if (count < selected.minTeamSize || count > selected.maxTeamSize) {
                teamMembersContainer.style.display = 'none';
                if (count < selected.minTeamSize) {
                    const message = `âŒ Team size error!\n\nMinimum ${selected.minTeamSize} members required for "${selected.name}"\nYou entered: ${count} members\n\nPlease enter a number between ${selected.minTeamSize} and ${selected.maxTeamSize}`;
                    alert(message);
                } else {
                    const message = `âŒ Team size exceeded!\n\nMaximum ${selected.maxTeamSize} members allowed for "${selected.name}"\nYou entered: ${count} members\n\nPlease enter a number between ${selected.minTeamSize} and ${selected.maxTeamSize}`;
                    alert(message);
                }
                teamMemberCountInput.value = '';
                return;
            }
            
            // Show container
            teamMembersContainer.style.display = 'block';
            console.log('Container shown');
            
            // Generate input fields with complete details (excluding team leader)
            membersInputs.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const memberCard = document.createElement('div');
                memberCard.style.cssText = 'padding: 20px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; margin-bottom: 15px;';
                
                const label = `<i class="fas fa-user" style="margin-right: 8px;"></i> <strong>Member ${i}</strong>`;
                
                memberCard.innerHTML = `
                    <div style="margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #dee2e6;">
                        <h6 style="margin: 0; color: #333;">${label}</h6>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <!-- Full Name -->
                        <div>
                            <label style="font-size: 0.85rem; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">
                                <i class="fas fa-user-circle"></i> Full Name *
                            </label>
                            <input type="text" class="form-control member-full-name" 
                                   placeholder="e.g., John Doe"
                                   data-member-index="${i}" maxlength="100" 
                                   style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px;" 
                                   required>
                        </div>
                        
                        <!-- Register Number -->
                        <div>
                            <label style="font-size: 0.85rem; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">
                                <i class="fas fa-id-badge"></i> Register Number *
                            </label>
                            <input type="text" class="form-control member-register" 
                                   placeholder="e.g., 21AID001"
                                   data-member-index="${i}" maxlength="20" 
                                   style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px;" 
                                   required>
                        </div>
                        
                        <!-- Department -->
                        <div>
                            <label style="font-size: 0.85rem; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">
                                <i class="fas fa-building"></i> Department *
                            </label>
                            <input type="text" class="form-control member-department" 
                                   placeholder="e.g., AIDS"
                                   data-member-index="${i}" maxlength="50" 
                                   style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px;" 
                                   required>
                        </div>
                        
                        <!-- Year -->
                        <div>
                            <label style="font-size: 0.85rem; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">
                                <i class="fas fa-graduation-cap"></i> Year *
                            </label>
                            <input type="text" class="form-control member-year" 
                                   placeholder="e.g., 2nd Year"
                                   data-member-index="${i}" maxlength="20" 
                                   style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px;" 
                                   required>
                        </div>
                        
                        <!-- Phone Number -->
                        <div>
                            <label style="font-size: 0.85rem; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">
                                <i class="fas fa-phone"></i> Phone Number *
                            </label>
                            <input type="text" class="form-control member-phone" 
                                   placeholder="e.g., 9876543210"
                                   data-member-index="${i}" maxlength="15" 
                                   style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px;" 
                                   required>
                        </div>
                        
                        <!-- Email -->
                        <div>
                            <label style="font-size: 0.85rem; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">
                                <i class="fas fa-envelope"></i> Email Account *
                            </label>
                            <input type="email" class="form-control member-email" 
                                   placeholder="e.g., john@gmail.com"
                                   data-member-index="${i}" maxlength="100" 
                                   style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px;" 
                                   required>
                        </div>
                    </div>
                `;
                membersInputs.appendChild(memberCard);
            }
            
            console.log('Generated', count, 'input fields');
            
            // Listen to all member input fields and update team_members field
            const allMemberInputs = membersInputs.querySelectorAll('input[type="text"], input[type="email"]');
            allMemberInputs.forEach(input => {
                input.addEventListener('input', updateTeamMembersField);
                input.addEventListener('change', updateTeamMembersField);
            });
            
            // Pre-fill if already has data
            updateMemberInputsFromField();
        }
        
        function updateTeamMembersField() {
            // Guard: ensure teamMembersInput exists
            if (!teamMembersInput) {
                console.error('teamMembersInput element not found');
                return;
            }
            
            const members = [];
            
            // Get all member name inputs
            const nameInputs = membersInputs.querySelectorAll('.member-full-name');
            console.log('Found', nameInputs.length, 'name inputs');
            
            nameInputs.forEach((nameInput) => {
                const currentIndex = nameInput.getAttribute('data-member-index');
                
                const registerInput = membersInputs.querySelector(`.member-register[data-member-index="${currentIndex}"]`);
                const deptInput = membersInputs.querySelector(`.member-department[data-member-index="${currentIndex}"]`);
                const yearInput = membersInputs.querySelector(`.member-year[data-member-index="${currentIndex}"]`);
                const phoneInput = membersInputs.querySelector(`.member-phone[data-member-index="${currentIndex}"]`);
                const emailInput = membersInputs.querySelector(`.member-email[data-member-index="${currentIndex}"]`);
                
                // Only add if register number is filled
                if (registerInput && registerInput.value.trim()) {
                    const memberData = {
                        register_number: registerInput.value.trim(),
                        full_name: nameInput.value.trim(),
                        email: emailInput ? emailInput.value.trim() : '',
                        phone: phoneInput ? phoneInput.value.trim() : '',
                        year: yearInput ? yearInput.value.trim() : '',
                        department: deptInput ? deptInput.value.trim() : ''
                    };
                    
                    members.push(memberData);
                    console.log(`Member ${currentIndex}:`, memberData);
                }
            });
            
            // Store as compact JSON (no newlines or indentation)
            const jsonString = JSON.stringify(members);
            teamMembersInput.value = jsonString;
            console.log('Updated team_members field with', members.length, 'members');
            console.log('JSON String:', jsonString);
        }
        
        function updateMemberInputsFromField() {
            if (!teamMembersInput || !teamMembersInput.value) return;
            
            try {
                const members = JSON.parse(teamMembersInput.value);
                if (Array.isArray(members)) {
                    members.forEach((member, index) => {
                        // Use index + 1 to match data-member-index (which starts from 1, not 0)
                        const memberIndex = index + 1;
                        const nameInput = membersInputs.querySelector(`.member-full-name[data-member-index="${memberIndex}"]`);
                        const registerInput = membersInputs.querySelector(`.member-register[data-member-index="${memberIndex}"]`);
                        const deptInput = membersInputs.querySelector(`.member-department[data-member-index="${memberIndex}"]`);
                        const yearInput = membersInputs.querySelector(`.member-year[data-member-index="${memberIndex}"]`);
                        const phoneInput = membersInputs.querySelector(`.member-phone[data-member-index="${memberIndex}"]`);
                        const emailInput = membersInputs.querySelector(`.member-email[data-member-index="${memberIndex}"]`);
                        
                        if (nameInput) nameInput.value = member.full_name || '';
                        if (registerInput) registerInput.value = member.register_number || '';
                        if (deptInput) deptInput.value = member.department || '';
                        if (yearInput) yearInput.value = member.year || '';
                        if (phoneInput) phoneInput.value = member.phone || '';
                        if (emailInput) emailInput.value = member.email || '';
                    });
                }
            } catch(e) {
                console.log('Could not parse team_members data:', e);
            }
        }
        
        // âœ… VALIDATE TEAM MEMBER COUNT IN REAL-TIME
        function validateTeamMemberCount() {
            const count = parseInt(teamMemberCountInput.value) || 0;
            const selectedEvent = competitionSelect.value;
            
            if (!selectedEvent || count === 0) {
                teamMemberCountInput.classList.remove('is-invalid');
                return true;
            }
            
            const selected = competitionData[selectedEvent];
            if (!selected || !selected.isTeamEvent) {
                return true;
            }
            
            const isValid = count >= selected.minTeamSize && count <= selected.maxTeamSize;
            
            if (isValid) {
                teamMemberCountInput.classList.remove('is-invalid');
            } else {
                teamMemberCountInput.classList.add('is-invalid');
            }
            
            return isValid;
        }
        
        if (teamMemberCountInput) {
            console.log('Attaching event listeners to team member count input');
            teamMemberCountInput.addEventListener('input', (e) => {
                validateTeamMemberCount();
                generateMemberInputs();
            });
            teamMemberCountInput.addEventListener('change', (e) => {
                validateTeamMemberCount();
                generateMemberInputs();
            });
        } else {
            console.error('teamMemberCountInput not found!');
        }
        
        // Form validation and enhancement
        const form = document.getElementById('registrationForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Validate team members if team event selected
                const selectedEvent = competitionSelect.value;
                if (selectedEvent && competitionData[selectedEvent] && competitionData[selectedEvent].isTeamEvent) {
                    const teamCount = parseInt(teamMemberCountInput.value) || 0;
                    
                    if (teamCount > 0) {
                        // Update team_members field one more time to ensure all data is saved
                        updateTeamMembersField();
                        
                        console.log('Team Members Data:', teamMembersInput.value);
                        
                        // Validate all member inputs are filled
                        const memberInputs = membersInputs.querySelectorAll('input[type="text"], input[type="email"]');
                        let hasErrors = false;
                        
                        memberInputs.forEach(input => {
                            if (input.hasAttribute('required') && !input.value.trim()) {
                                input.style.borderColor = '#dc3545';
                                hasErrors = true;
                            } else {
                                input.style.borderColor = '';
                            }
                        });
                        
                        if (hasErrors) {
                            e.preventDefault();
                            alert('Please fill all team member details');
                            return false;
                        }
                    }
                }
                
                // Add loading state to submit button
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Registration...';
                    submitBtn.disabled = true;
                }
            });
        }
    });
</script>
{% endblock %}